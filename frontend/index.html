<!DOCTYPE html>
<html>
<body>
    <button type="button" onclick="connectWallet()">Connect</button>
    <button type="button" onclick="disconnectWallet()">Disconnect</button>
    <button type="button" onclick="queryCanister()">Query</button>
    <button type="button" onclick="debug()">Debug</button>
    <script>

    ;(async () => {
        const connected = await window.ic.plug.isConnected()
        if (connected) {
            alert('connected')
            // console.log(JSON.stringify(windows.ic.plug))
        }
    })()
    
    const debug = async () => {
        // console.log(window.ic.plug.sessionManager.getSession())
        console.log(window.ic.plug)
        // console.log(await window.ic.plug.sessionManager.getConnectionData())
        // console.log(await window.ic.plug.getICNSInfo())
    }

    const disconnectWallet = async () => {
        // const p1 = new Promise((r) => setTimeout(() => r(), 1000))
		// const p2 = window.ic.plug.disconnect() // not resolving
		// await Promise.race([p1, p2]) // hacky fix

        await window.ic.plug.disconnect()
    }

    const connectWallet = async () => {

        if (!window.ic?.plug) {
            alert('no wallet')
            return
        }

        try {
            const host = 'https://mainnet.plugwallet.ooo'
		    const whitelist = ['rrkah-fqaaa-aaaaa-aaaaq-cai']
			await window.ic?.plug?.requestConnect({ host, whitelist })
            const x = await window.ic?.plug.sessionManager.sessionData?.agent.fetchRootKey()
            console.log('root key', x)
        } catch (e) {
            console.log(e)
        }
        
    }
    const queryCanister = async () => {
        const canisterId = 'rrkah-fqaaa-aaaaa-aaaaq-cai';
        const interfaceFactory = ({ IDL }) => {
            return IDL.Service({ 
                'query_call' : IDL.Func([], [IDL.Text], ['query']), 
                'update_call' : IDL.Func([], [], ['update']), 
            });
        };
        const actor = await window.ic?.plug.createActor({ canisterId, interfaceFactory });
        const response = await actor.query_call();
        console.log('query_call', response);

        const response2 = await actor.update_call();
        console.log('update_call', response2);
    }
    </script>
</html>
